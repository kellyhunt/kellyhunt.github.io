<!DOCTYPE html>

<!-- ___PRODUCT_BUILD___ (___PRODUCT_COMMENTS___) ___PRODUCT_DATE___ -->

<html>
<head>
<title>Chat</title>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="css/wrong.css" rel="stylesheet" type="text/css">
<link href="css/override.css" rel="stylesheet" type="text/css">
<!--link href="js/perfect-scrollbar/perfect-scrollbar.min.css" rel="stylesheet" type="text/css"-->

<script type="text/javascript" src="js/json2.min.js"></script>
<script type="text/javascript" src="js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="js/datetime.min.js"></script>
<script type="text/javascript" src="js/perfect-scrollbar/perfect-scrollbar.min.js"></script>
<script type="text/javascript" src="js/jQuery.XDomainRequest.min.js"></script>
<script type="text/javascript" src="js/chat-api-session.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.11.1.min.js"></script>
<script type="text/javascript" src="js/client-chat-ui.js"></script>
<script type="text/javascript" src="js/autosize.min.js"></script>
<script type="text/javascript"> (function(){

    var cp = {};
    var currentFormName = '';
    var currentFormRequestId = '';
    var currentForm = null;
    var extChatData = {};

    var getUrlVars = function(url) {
        var vars = {}, hash;
        var hashes = url.slice(url.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars[hash[0]] = decodeURIComponent(hash[1]);
        }
        return vars;
    };

    var makeid = function () {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        for( var i=0; i < 5; i++ )
            text += possible.charAt(Math.floor(Math.random() * possible.length));

        return text;
    };

    var mobileCheck = function() {
        var check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
    };

    var updateScrollbar = function() {
        var outer = $('#messages-div-outer');
        var inner = $('#messages-div-inner');
        var ih = inner.height();
        var oh = outer.height();
        outer.perfectScrollbar('update');

        inner.css("bottom", ih > oh ? "auto" : "0" );

        inner.css("top", ih > oh ? "0" : "auto" );

        if(ih > oh) {
            outer.scrollTop(ih);
        }
    };

    var safeEndSession = function() {

        if(window.chatSession.sessionStatus == 'connected') {
            //session queued or connected, need disconnect
            var confirm = window.confirm("Do you want to end the chat session?");
            if(confirm) {
                window.chatSession.sessionStatus = undefined;
                window.chatSession.disconnectSession();
            }
        } else if(!window.chatSession.sessionEnded) {
            window.chatSession.endSession();
        } else {
            window.chatSession.uiCallbacks.onSessionEnded();
        }
    };

    $(window).on("message", function(event) {
        var data = '' + event.originalEvent.data;
        if(data.indexOf("sp-") == 0) {
            if(data == 'sp-dragged') {
                updateScrollbar();
            } else if(data == 'sp-disconnect') {
                safeEndSession();
            } else if(data == 'share-screen') {
//                window.chatSession.send(event.data.data);
            } else if(data =='sp-req-notification') {
                $('#notification-prompt').css("display", "block");
            } else if(data =='sp-req-notification-end') {
                $('#notification-prompt').css("display", "none");
            } else if(data.indexOf("sp-together-url") == 0) {
                window.chatSession.send("Click to start co-browsing session:" + data.replace("sp-together-url", ""));
            } else if(data == "sp-started-together") {
            	$('#shareScreen').addClass('stop-sharing');
            } else if(data == "sp-stopped-together") {
            	$('#shareScreen').removeClass('stop-sharing');
            }
        }
    });

    var forms = {
        //deprecated form
        question_form: {
            html: '',

            onShow: function() {

                window.parent.postMessage("sp-chat-init", "*");

                $('#offline-form').css("display", "block");
                $('#questionForm').css("display", "block");

                if (window.chatSession) {
                    window.chatSession.reassignUICallbacks({
                        onLogEvent: function(event) {
                            $.chatUI.appendLog(event);
                            updateScrollbar();
                        }
                    });
                }
            },
            onHide: function() {
                $('#offline-form').css("display", "none");
                $('#questionForm').css("display", "none");
            },
            onSubmit: function() {}
        },
        MobileChatCustomerData: {
            html: '',

            onShow: function() {

                window.parent.postMessage("sp-chat-init", "*");

                $('#offline-form').css("display", "block");
                $('#questionForm').css("display", "block");

                if (window.chatSession) {
                    window.chatSession.reassignUICallbacks({
                        onLogEvent: function(event) {
                            $.chatUI.appendLog(event);
                            updateScrollbar();
                        }
                    });
                }
            },
            onHide: function() {
                $('#offline-form').css("display", "none");
                $('#questionForm').css("display", "none");
            },
            onSubmit: function() {}
        },
        find_agent_form: {
            html: '',
            onShow: function() {
                //$.chatUI.alignChatControls();
                window.chatSession.sessionStatus = 'queued';

                window.parent.postMessage("sp-chat-drag", "*");

                $('#agent-name').text("Waiting for agent...");
                $('#agent-name').attr("title", $('#agent-name').text());

                $('#chat-body').css("display", "block");
                $('#chat-body').removeClass("sp-readonly");

                $('#messages-div-outer').perfectScrollbar({useBothWheelAxes: false});

                if (window.chatSession) {
                    window.chatSession.reassignUICallbacks({
                        onLogEvent: function(event) {
                            $.chatUI.appendLog(event);
                            updateScrollbar();

                            if(window.chatSession.internalParty) {
                                $('#agent-name').text(window.chatSession.internalParty.displayName);
                                $('#agent-name').attr("title", $('#agent-name').text());
                                var url = window.chatSession.getProfilePhotoUrl(window.chatSession.internalParty.id);
                                $('.avatar-image').attr("src", url);
                            } else {
                                $('#agent-name').text("Waiting for agent...");
                                $('#agent-name').attr("title", $('#agent-name').text());
                                $('.avatar-image').attr("src", 'images/logo-big.png');
                            }
                        }
                    });
                }
                window.setTimeout(function() {autosize($('#input-field'));}, 400);
            },
            onHide: function() {
                window.chatSession.sessionStatus = undefined;
                $('#chat-body').css("display", "none");
            },
            onSubmit: function() {}
        },

        start_form: {
            html: '',
            onShow: function() {

                window.parent.postMessage("sp-chat-drag", "*");

                $('#chat-body').css("display", "block");
                $('#chat-body').removeClass("sp-readonly");

                $('#messages-div-outer').perfectScrollbar({useBothWheelAxes: false});

                if (window.chatSession) {
                    window.chatSession.reassignUICallbacks({
                        onLogEvent: function(event) {
                            $.chatUI.appendLog(event);
                            updateScrollbar();
                        }
                    });
                }
            },
            onHide: function() {
                $('#chat-body').css("display", "none");
            },
            onSubmit: function() {}
        },


        connect_chat_form: {
            html: '',

            onShow: function() {
                window.chatSession.sessionStatus = 'connected';
                $('#chat-body').css("display", "block");
                $('#callme').css("display", (window.mozRTCPeerConnection || window.webkitRTCPeerConnection) ? "block" : "none");
                $('#callme').removeClass('hang-up');
                if (getUrlVars(window.location.href)['togetherJS_enabled'] == 'true') {
                	$('#shareScreen').css("display", "block");
                }
                $('#endChat').css("display", "block");
                $('#chat-body').removeClass("sp-readonly");

                $('#agent-title').text("Consultant");

                $('#messages-div-inner').css("bottom", "0");
                $('#messages-div-inner').css("top", "auto");

                $('#messages-div-outer').perfectScrollbar({useBothWheelAxes: false});

                window.parent.postMessage("sp-get-status-together", "*");

                if (window.chatSession) {

                    window.parent.postMessage("sp-session-start", "*");//request web notifications

                    window.chatSession.reassignUICallbacks({
                        onLogEvent: function(event) {
                            if(event.msg == "/ban") {
                                var store = {
                                    action: "sp-storage",
                                    key: "bp-bc",
                                    value: "1"
                                };
                                window.parent.postMessage(JSON.stringify(store), "*");
                                window.chatSession.disconnectSession();
                                window.chatSession.endSession();
                                return;
                            }
                            var event = $.chatUI.appendLog(event);
                            var history = !window.chatSession.historyReceived || window.chatSession.historyRendered;
                            if(history && event.fromClass !== 'me' && event.fromClass !== 'sys') {
                                var a = {
                                    action: "sp-notification",
                                    photo: event.profilePhotoUrl,
                                    msg: event.originalMsg,
                                    name: event.fromName
                                }
                                window.parent.postMessage(JSON.stringify(a), "*");
                            }

                            if(window.chatSession.internalParty) {
                                $('#agent-name').text(window.chatSession.internalParty.displayName);
                                $('#agent-name').attr("title", $('#agent-name').text());
                                var url = window.chatSession.getProfilePhotoUrl(window.chatSession.internalParty.id);
                                $('.avatar-image').attr("src", url);
                            }
                            updateScrollbar();
                        },
                        onSessionTyping: function(a) {
                            $('#agent-typing').css('display', 'block');
                            $('.agent-typing-wrapper').text(a.displayName + ' is typing');
                        },
                        onSessionNotTyping: function() {
                            $('#agent-typing').css('display', 'none');
                        },
                        onAddStream: function(src) {
                            var video = $('#video');
                            video.attr('src', src);
                            video.css('display', 'block');
                            $('#callme').addClass('hang-up');
                            $('#servicepattern-chat').css('top', '120px');
                            updateScrollbar();
                        }
                    });
                }
            },
            onHide: function() {
                window.chatSession.sessionStatus = undefined;
                $('#endChat').css("display", "none");
                $('#chat-body').css("display", "none");
                $('#video').css("display", "none");
                $('#servicepattern-chat').css('top', '0');
                $('#callme').css("display", "none");
                $('#shareScreen').css("display", "none");
                $('#agent-title').text("");
                $('.avatar-image').attr("src", 'images/logo-big.png');
                updateScrollbar();
            },
            onSubmit: function() {
                this.submitForm();
            },
            submitForm: function() {
                window.chatSession.sendFormData(currentFormRequestId, currentFormName, {});
            }
        },
        chat_unavailable_form: {
            html: '',
            onShow: function() {
                window.chatSession.sessionStatus = undefined;
                window.parent.postMessage("sp-chat-init", "*");

                $('#agent-name').text("Send us a message");
                $('#agent-name').attr("title", $('#agent-name').text());
                $('#offline-form').css("display", "block");
                $('#unavailableForm').css("display", "block");
            },
            onHide:     function() {
                $('#offline-form').css("display", "none");
                $('#unavailableForm').css("display", "none");
            },
            onSubmit:   function() {}
        },
        survey_form: {
            html: '',
            onShow: function() {

                window.parent.postMessage("sp-chat-init", "*");

                $('#offline-form').css("display", "block");
                $('#surveyForm').css("display", "block");

                $('#agent-name').text("Please leave us a feedback");
                $('#agent-name').attr("title", $('#agent-name').text());

                $("#transcriptEmail").val(extChatData.email);
            },
            onHide: function() {
                $('#offline-form').css("display", "none");
                $('#surveyForm').css("display", "none");
            },
            onSubmit: function() { },
            submitForm: function() { }
        },
        MobileChatSurvey: {
            html: '',
            onShow: function() {

                window.parent.postMessage("sp-chat-init", "*");

                $('#offline-form').css("display", "block");
                $('#surveyForm').css("display", "block");

                $('#agent-name').text("Please leave us a feedback");
                $('#agent-name').attr("title", $('#agent-name').text());

                $("#transcriptEmail").val(extChatData.email);
            },
            onHide: function() {
                $('#offline-form').css("display", "none");
                $('#surveyForm').css("display", "none");
            },
            onSubmit: function() { },
            submitForm: function() { }
        }
    };

    var showForm = function(fn, frId) {
        var nf = forms[fn];
        if(nf) {
            var frm = document.getElementById('content-form');
            if(frm) {
                if(currentForm && typeof currentForm.onHide === 'function') {
                    currentForm.onHide();
                }

                frm.innerHTML = nf.html;
                currentForm = nf;

                if(frId) {
                    currentFormName = fn;
                    currentFormRequestId = frId;
                }

                if(typeof currentForm.onShow === 'function') {
                    currentForm.onShow();
                }
            }
        }
    };

    var onFormSubmit = function(e) {
        e.preventDefault();

        if(currentForm && typeof currentForm.onSubmit === 'function') {
            currentForm.onSubmit();
        }
    };


    var connect = function() {
        $.chat.createSession({
            url: cp.webServer,
            crossDomain: true,
            tenantUrl: cp.tenantUrl,
            appId: cp.appId,
            clientId: 'WebChat',
            phone_number: cp.phone_number,
			from: cp.from,
            parameters: cp.parameters || {}
        }).fail(function(e) {
                    $('#error').text(e.text + ". Retrying...");
//            $('#error').css('display', 'block');
                    window.setTimeout(connect, 4000);
                }).done(function(o) {
                    $('#error').css('display', 'none');
                    window.sessionStorage.setItem("sp-chat-session", o.session.sessionId);

                    showForm('start_form', '');
                    initDragAndDrop();
                    o.session.assignUICallbacks({
                        onFormShow: function(f) { showForm(f.form_name, f.form_request_id); },
                        onChatConnected: function() { showForm('connect_chat_form', ''); },
                        onChatQueued: function() { showForm('find_agent_form', ''); },
                        onFormSent: function () {
                            if(o.session.sessionStatus) {
                                switch(o.session.sessionStatus) {
                                    case 'queued':
                                        showForm('find_agent_form', '');
                                        break;
                                    case 'connected':
                                        showForm('connect_chat_form', '');
                                        break;
                                }
                            } else {
                                showForm('start_form', '');
                            }
                        },
                        onLogEvent: function(event) {
                            $.chatUI.appendLog(event);
                            updateScrollbar();
                        },
                        onSessionEnded: function() {
                            if(!o.is_new_chat && !o.session.historyReceived) {
                                /*history has not been received, we should connect again*/
                                connect();
                            } else {
                                if(o.session.sessionStatus) {
                                    o.session.sessionStatus = undefined;
                                    //the session is ended, but there is no party
                                    //it occurs when no agent available, no need to close chat
                                    //there is some messages, chat closed bu customer

                                    $('#callme').css("display", "none");
                                    $('#chat-body').addClass("sp-readonly");
                                    $('#agent-name').text("Session completed");
                                    $('.avatar-image').attr("src", 'images/logo-big.png');
                                    $('#agent-title').text("");
                                    updateScrollbar();
                                    return;
                                }
                                if(mobileCheck()) {
                                    window.location.replace(getUrlVars(window.location.href)['referrer']);
                                } else {
                                    window.setTimeout(function() {
                                        window.parent.postMessage("sp-session-end", "*");
                                    }, 50);
                                }
                            }
                        }});

                    if (!o.is_new_chat) {
                        o.session.getHistory();
                    }
                    window.chatSession = o.session;
                    var urlVars = getUrlVars(window.location.href);
                    $.chatUI.sendNavigation(o.session, urlVars['referrer'], urlVars['referrerTitle']);
                });
    };

    var uploadFile = function(file) {
        var formData = new FormData();
        formData.append("file-upload-input", file);

        var id = makeid();

        $.chatUI.appendLog({fromClass: "me", msg: "Uploading \"" + file.name + "\"", msgId: id});
        $.chat.uploadFiles(window.chatSession.cp, formData)
                .fail(function(fail) {
                    $('#'+id).detach();
                    $.chatUI.appendLog({fromClass: "sys", msg: "Error: " + fail.responseJSON.error_message});
                })
                .done(function (done) {
                    $('#'+id).detach();
                    if (done && done.file_id) {
                        if (window.chatSession) {
                            var type = 'attachment';
                            if(file.type.match('image.*')) {
                                type = 'image';
                            } else {
                                updateScrollbar();
                            }

                            window.chatSession.fileUploaded(done.file_id, type, done.file_name);
                        }
                    }
                });
    };

    var uploadFiles = function(files) {
        for (var i = 0, item; item = files[i]; i++) {
            uploadFile(item);
        }
    };

    var initDragAndDrop = function() {
        var obj = $("#chat-body");

        var timeoutID;


        obj.on('dragenter dragleave dragover drop', function (e) {
            e.stopPropagation();
            e.preventDefault();
        });

        obj.on('dragenter', function (e) {
            if($('#attachFile').is(':visible')) {
                obj.attr("dnd", "1");

                if(timeoutID) {
                    window.clearTimeout(timeoutID);
                    timeoutID = null;
                }
            }
        });
        obj.on('dragleave', function (e) {
            if(timeoutID) {
                window.clearTimeout(timeoutID);
                timeoutID = null;
            } else {
                timeoutID = window.setTimeout(function() {obj.attr("dnd", null);}, 200);
            }
        });

        obj.on('dragover', function (e) {
            obj.attr("dnd", "1");
            if(timeoutID) {
                window.clearTimeout(timeoutID);
                timeoutID = null;
            }
        });
        obj.on('drop', function (e) {
            uploadFiles(e.originalEvent.dataTransfer.files);
            obj.attr("dnd", null);
            if(timeoutID) {
                window.clearTimeout(timeoutID);
                timeoutID = null;
            }
        });
    };

    $.support.cors = true;
    $(document).ready(function() {
        var args = getUrlVars(window.location.href);
        for (var arg in args) if (args.hasOwnProperty(arg)) {
            cp[arg] = args[arg];
        }

        if(mobileCheck()) {
            $('#inner-chat').addClass("mobile-version");
        }

        if(navigator.userAgent.match(/iPhone/i)) {
            $('#input-div').addClass("input-div-iphone");
        }

        $(document.getElementById('content-form')).on("submit", onFormSubmit);

        cp.parameters = {};
        cp.parameters.email            = cp.email;
        cp.parameters.last_name        = cp.last_name;
        cp.parameters.first_name       = cp.first_name;
        cp.parameters.account_number   = cp.account_number;
        cp.parameters.logging          = cp.logging;

        cp.parameters.location         = {};
        cp.parameters.location.latitude = cp.latitude;
        cp.parameters.location.longitude = cp.longitude;

        connect();

        $('#servicepattern_close_button').bind('click', function() {
            safeEndSession();
        });

        $('#input-button').bind('click', function() {
            $.chatUI.sendMessage(window.chatSession);
        });

        $('#uncancel').bind('click', function() {
            window.chatSession.endSession();
        });

        $("#submitSurvey").bind("click", function() {

            var data = {};
            var radios = $('input[name="service"]:checked');
            if(radios.length > 0)
                data.service = radios.get(0).value;

            radios = $('input[name="helpful"]:checked');
            if(radios.length > 0)
                data.helpful = radios.get(0).value;

            radios = $('input[name="recommend"]:checked');
            if(radios.length > 0)
                data.recommend = radios.get(0).value;

            radios = $('input[name="transcript"]:checked');
            if(radios.length > 0)
                data.transcript = radios.get(0).value;

            data.transcriptEmail = $('#transcriptEmail').val();

            window.chatSession.sendFormData(currentFormRequestId, currentFormName, data);
        });

        $('#unsubmit').bind('click', function() {

            extChatData = {
                question: $('#unmessage').val(),
                email: $('#unemail').val()
            };

            window.chatSession.sendFormData(currentFormRequestId, currentFormName, extChatData);
        });

        $('#input-field').bind('keypress', function(event) {
            $.chatUI.msgKeyPress(event, window.chatSession);
        });

        $('#input-field').bind('blur', function(event) {
            $.chatUI.notTyping(window.chatSession);
        });

        $('#first_name').bind('focus', function() {
            $('#error-first_name').css("display", "none");
        });

        $('#last_name').bind('focus', function() {
            $('#error-last_name').css("display", "none");
        });

        $('#email').bind('focus', function() {
            $('#error-phone').css("display", "none");
        });

      

        $('#question').bind('focus', function() {
            $('#error-message').css("display", "none");
        });

        $('#endChat').bind('click',
                function() {
                    window.chatSession.disconnectSession();
                });

        $('#callme').bind('click', function() {
            if($('#callme').hasClass("hang-up")) {
                window.chatSession.webRTC.closeConnection();
                $('#callme').removeClass("hang-up");
                $('#video').css("display", "none");
                $('#servicepattern-chat').css('top', '0');
                updateScrollbar();
            } else {
                if(window.chatSession.internalParty) {
                    window.chatSession.callPrompt = $('#call-prompt');
                    window.chatSession.webRTCSignaling(window.chatSession.internalParty.id).requestCall(true);
                }
            }
        });

        $('#shareScreen').bind('click', function() {
            if($('#shareScreen').hasClass('stop-sharing')) {
                //$('#shareScreen').removeClass('stop-sharing');
                //window.parent.postMessage("sp-stop-screen-sharing", "*");
                window.parent.postMessage("sp-stop-together", "*");
            } else {
                //$('#shareScreen').addClass('stop-sharing');
                //window.parent.postMessage("sp-start-screen-sharing", "*");
                window.parent.postMessage("sp-start-together", "*");
            }
        });


        $('#requestAudio').bind('click', function() {
            if(window.chatSession.internalParty) {
                window.chatSession.callPrompt = $('#call-prompt');
                window.chatSession.webRTCSignaling(window.chatSession.internalParty.id).requestCall(false);
            }
        });

        $('#submit').bind('click', function() {

            extChatData = {
                question:       $('#question').val(),
                first_name:     $('#first_name').val(),
                last_name:      $('#last_name').val(),
                account_number: $('#account_number').val(),
                email:          $('#email').val()
            };

            var noError = true;

            if(extChatData.first_name === undefined || extChatData.first_name === '') {
                $('#error-first_name').css("display", "block");
                noError = false;
            }
            if(extChatData.last_name === undefined || extChatData.last_name === '') {
                $('#error-last_name').css("display", "block");
                noError = false;
            }
            if(extChatData.email === undefined || extChatData.email === '') {
                $('#error-phone').css("display", "block");
                noError = false;
            }
            if(extChatData.question === undefined || extChatData.question === '') {
            $('#error-message').css("display", "block");
             noError = false;
            }

            if(noError) {
                window.chatSession.sendFormData(currentFormRequestId, currentFormName, extChatData);
                window.chatSession.send(extChatData.question);
            }
        });

        $('#attachFile').bind('click', function() {
            $('#file-upload-form').html('<input type="file" id="attach-file" name="file-upload-input"/>');
            $('#attach-file').on('change', function(event) {
                uploadFiles(event.target.files);
            });
            $('#attach-file').click();
        });
    });
})();
</script>
</head>

<body id="inner-chat">

<div id="web_phone" class="phone_hidden">
    <div id="rtc_placeholder"></div>
    <div id="up_arrow"></div>
    <div id="phone_hint">Click "Allow" to use microphone for the call.
        <br>Your web cam will not be used</div>
</div>

<div id="sound_player" style="width: 0; height: 0;">
    <img id="jp_poster_0" style="width: 0px; height: 0px; display: none;">
    <audio id="jp_audio_0" preload="metadata" src=""></audio>
</div>

<div id="contents_placeholder"></div>
<div id="servicepattern_action">
    <div id="servicepattern_close_button"></div>
</div>

<div id="servicepatternsite-iframe-chat">
    <div id="header-avatar" class="header light">
        <div id="header-avatar-container">
            <div class="has-avatar">
                <div class="avatar">
                    <img class="avatar-image" src="images/logo-big.png">
                </div>
            </div>
        </div>
        <div class="clear"></div>
        <div class="sound_player"></div>
        <div id="callme" style="display: none;"><div></div></div>
        <div id="shareScreen" style="display: none;"><div></div></div>
        <div id="endChat" style="display: none;"><div></div></div>
    </div>


    <form id="content-form" method="POST">



    </form>

    <div id="offline-form" style="display: none;" >
        <div id="offline-form-inner" >

            <div id="questionForm" style="display: none;">
                <div class="description">Please fill the following information:</div>

                <div class="field-wrapper">
                    <input id="first_name" type="text" class="input-field" name="first_name" placeholder="Full name*" value="">
                    <div id="error-first_name" class="error-balloon">Please enter your full name</div>
                </div>

                <div class="field-wrapper">
                    <input id="email" type="text" class="input-field" placeholder="Email Address*" value="">
                    <div id="error-phone" class="error-balloon">Please enter email address on record</div>
                </div>

                <div class="field-wrapper">
                    <input id="account_number" type="text" class="input-field" placeholder="Mastercode*" value="">
                    <div id="error-account_number" class="error-balloon">Please enter your Mastercode</div>
                </div>

                <div class="field-wrapper message">
                    <textarea id="question" class="input-field" placeholder="Your message"></textarea>
                    <div id="error-message" class="error-balloon multiline">Please enter your message</div>
                </div>

                <div class="buttons">
                    <!--div class="left-button">
                        <a id="cancel" class="servicepatternBtn cancel" href="#">Cancel</a>
                    </div-->
                    <div>
                        <input id="submit" type="button" value="Send" class="servicepatternBtn accept">
                    </div>
                </div>
            </div>

            <div id="unavailableForm" style="display: none;">
                <div id="offline-form-fields">
                    <div class="description">Sorry, no one is available for chat right now. Please leave us a message, we will get in touch soon.</div>

                    <div class="field-wrapper message">
                        <textarea id="unmessage" class="input-field" placeholder="Your message*" style="height: 170px;"></textarea>
                        <div id="unerror-message" class="error-balloon multiline">Please, enter message</div>
                    </div>


                    <div class="field-wrapper">
                        <input id="unemail" type="email" class="input-field" placeholder="Your email*" value="">
                        <div id="error-email" class="error-balloon">Please, enter valid email</div>
                    </div>

                    <div class="buttons">
                        <div class="left-button">
                            <a id="uncancel" class="servicepatternBtn cancel" href="#">Cancel</a>
                        </div>
                        <div>
                            <input id="unsubmit" type="button" value="Send" class="servicepatternBtn">
                        </div>
                    </div>

                    <div class="clear"></div>
                </div>
            </div>

            <div id="surveyForm" style="display: none;">
                <div class="description small">Did we provide the service you were looking for?</div>

                <div class="field-wrapper">
                    <input type="radio" name="service" id="service-1" value="1" checked="checked"> <label for="service-1">yes</label>
                    <input type="radio" name="service" id="service-0" value="0"> <label for="service-0">no</label>
                </div>

                <br/>

                <div class="description small">How helpful was our representative?</div>
                <p>
                <div class="thumbUp"></div>
                <div class="thumbDown"></div>

                    <input type="radio" name="helpful" id="helpful-1" value="1">
                    <input type="radio" name="helpful" id="helpful-2" value="2">
                    <input type="radio" name="helpful" id="helpful-3" value="3">
                    <input type="radio" name="helpful" id="helpful-4" value="4">
                    <input type="radio" name="helpful" id="helpful-5" value="5">
                    <input type="radio" name="helpful" id="helpful-6" value="6">
                    <input type="radio" name="helpful" id="helpful-7" value="7">
                    <input type="radio" name="helpful" id="helpful-8" value="8">
                    <input type="radio" name="helpful" id="helpful-9" value="9">
                </p>

                <br/>

                <div class="description small">How likely are you recommend our products and services in the future?</div>
                <p>
                    <div class="thumbUp"></div>
                    <div class="thumbDown"></div>
                    <input type="radio" name="recommend" id="recommend-1" value="1">
                    <input type="radio" name="recommend" id="recommend-2" value="2">
                    <input type="radio" name="recommend" id="recommend-3" value="3">
                    <input type="radio" name="recommend" id="recommend-4" value="4">
                    <input type="radio" name="recommend" id="recommend-5" value="5">
                    <input type="radio" name="recommend" id="recommend-6" value="6">
                    <input type="radio" name="recommend" id="recommend-7" value="7">
                    <input type="radio" name="recommend" id="recommend-8" value="8">
                    <input type="radio" name="recommend" id="recommend-9" value="9">
                </p>

                <br/>

                <input type="checkbox" name="transcript" id="transcript" value="1">
                <label for="transcript" class="description small">Send me transcript of the chat by email?</label>
                <input type="text" name="transcriptEmail" id="transcriptEmail"/>

                <div class="buttons" style="margin-top: -10px;">
                    <!--div class="left-button">
                        <a id="cancel" class="servicepatternBtn cancel" href="#">Cancel</a>
                    </div-->
                    <div>
                        <input id="submitSurvey" type="button" value="Submit" class="servicepatternBtn">
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="chat-body" style="display: none;">
        <video id="video" style="display: none; height: 100px; width: 100%" autoplay></video>
        <div id="notification-prompt" style="display: none;" class="promptMessage">When prompted, please allow notifications from this window, so you could see responses when this window is hidden.</div>
        <div id="call-prompt" style="display: none;" class="promptMessage">When prompted, please allow access to your camera and microphone.</div>
        <div id="servicepattern-chat">
            <div id="scrollbar-container">
                <div id="messages-div" class="viewport">
                    <div id="messages-div-outer">
                        <div id="messages-div-inner" class="overview messages-div-inner">
                            <div id="messages-div-inner-clear"></div>
                        </div>
                     </div>
                    <div id="agent-typing" style="display: none;"><div class="agent-typing-wrapper"></div></div>
                </div>
            </div>
        </div>

        <div id="input-div" class="">
            <div class="input-div-table">
                <div id="attachFile"></div>
                <div class="td-textarea">
                    <textarea id="input-field" rows="1" name="input-field" maxlength="1000" placeholder="Type here and hit <Enter>" autocomplete="off" style="resize: none;"></textarea>
                </div>
                <div class="td-button">
                    <input id="input-button" type="button" value="Send" class="servicepatternBtn accept">
                </div>
            </div>
        </div>
    </div>
</div>
<form name="file-upload-form" id="file-upload-form" target="_blank" method="post" enctype="multipart/form-data" style="display:none;">

</form>

</body>
</html>
